# 组件架构

## 概述

点火引擎（Ignition）项目采用微服务架构和前后端分离设计。本文档详细说明系统的组件架构、组织结构和交互方式。

## 系统架构图

```
┌─────────────────────────────────┐
│         客户端应用层            │
│  ┌─────────┐     ┌──────────┐   │
│  │用户中心 │     │材料管理  │   │
│  │ UI      │     │UI        │   │
│  └─────────┘     └──────────┘   │
└───────────────┬─────────────────┘
                │
                ▼
┌─────────────────────────────────┐
│            API网关层            │
│  ┌─────────────────────────┐    │
│  │       API Gateway       │    │
│  └─────────────────────────┘    │
└───────────────┬─────────────────┘
                │
                ▼
┌─────────────────────────────────┐
│           微服务应用层          │
│  ┌─────────┐ ┌───────────┐      │
│  │用户服务 │ │材料服务   │      │
│  └─────────┘ └───────────┘      │
│  ┌─────────┐ ┌───────────┐      │
│  │DevOps   │ │Ignition   │      │
│  │服务     │ │服务       │      │
│  └─────────┘ └───────────┘      │
└───────────────┬─────────────────┘
                │
                ▼
┌─────────────────────────────────┐
│            数据存储层           │
│  ┌─────────┐ ┌───────────┐      │
│  │ MySQL   │ │ MongoDB   │      │
│  └─────────┘ └───────────┘      │
│  ┌─────────┐                    │
│  │ Redis   │                    │
│  └─────────┘                    │
└─────────────────────────────────┘
```

## 前端组件架构

### 客户端应用

```
clients/
├── user-center/        # 用户中心客户端
│   ├── src/
│   │   ├── assets/     # 静态资源
│   │   ├── components/ # UI组件
│   │   │   ├── common/ # 通用组件
│   │   │   ├── layout/ # 布局组件
│   │   │   └── pages/  # 页面组件
│   │   ├── hooks/      # 自定义Hook
│   │   ├── services/   # API服务
│   │   ├── store/      # 状态管理
│   │   ├── utils/      # 工具函数
│   │   ├── routes/     # 路由配置
│   │   └── App.tsx     # 应用入口
│   └── public/         # 公共资源
└── material-center/    # 材料中心客户端
    └── ...             # 结构类似user-center
```

### 共享库

```
libs/
├── shared-ui/          # 共享UI组件
│   ├── src/
│   │   ├── components/ # 基础组件
│   │   ├── themes/     # 主题定义
│   │   └── hooks/      # UI相关Hook
│   └── package.json
├── shared-utils/       # 共享工具函数
│   ├── src/
│   │   ├── formatters/ # 格式化工具
│   │   ├── validators/ # 验证工具
│   │   └── helpers/    # 辅助函数
│   └── package.json
└── auth/               # 认证相关库
    ├── src/
    │   ├── providers/  # 认证提供者
    │   ├── hooks/      # 认证相关Hook
    │   └── context/    # 认证上下文
    └── package.json
```

### 前端组件层次

```
┌───────────────────────────────────────────┐
│               应用容器 (App)              │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│               布局组件 (Layouts)          │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    主布局           │ │  登录布局    │ │
│  │ (MainLayout)        │ │ (AuthLayout) │ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│               页面组件 (Pages)            │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    用户管理         │ │  角色管理    │ │
│  │  (UserManagement)   │ │(RoleManager) │ │
│  └─────────────────────┘ └──────────────┘ │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    材料列表         │ │  材料详情    │ │
│  │  (MaterialList)     │ │(MaterialView)│ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│            业务组件 (Business Components) │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │   用户表格          │ │ 权限选择器   │ │
│  │  (UserTable)        │ │(PermSelector)│ │
│  └─────────────────────┘ └──────────────┘ │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │   材料卡片          │ │ 标签编辑器   │ │
│  │  (MaterialCard)     │ │ (TagEditor)  │ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│            基础组件 (Base Components)     │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │     按钮            │ │   输入框     │ │
│  │    (Button)         │ │   (Input)    │ │
│  └─────────────────────┘ └──────────────┘ │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │     表格            │ │   模态框     │ │
│  │    (Table)          │ │   (Modal)    │ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────────────────────────────────┘
```

### 状态管理结构

使用Context API + Hooks进行状态管理：

```
store/
├── auth/              # 认证相关状态
│   ├── AuthContext.ts # 认证上下文
│   ├── AuthProvider.tsx # 认证提供者
│   ├── authReducer.ts # 认证状态reducer
│   └── useAuth.ts     # 认证状态Hook
├── users/             # 用户管理状态
│   ├── UsersContext.ts
│   ├── UsersProvider.tsx
│   ├── usersReducer.ts
│   └── useUsers.ts
└── materials/         # 材料管理状态
    ├── MaterialsContext.ts
    ├── MaterialsProvider.tsx
    ├── materialsReducer.ts
    └── useMaterials.ts
```

## 后端组件架构

### 微服务结构

```
apps/
├── userServer/        # 用户服务
│   ├── src/
│   │   ├── auth/      # 认证模块
│   │   ├── users/     # 用户模块
│   │   ├── roles/     # 角色模块
│   │   ├── permissions/ # 权限模块
│   │   └── main.ts    # 服务入口
│   └── test/          # 测试目录
├── materialsServer/   # 材料服务
│   ├── src/
│   │   ├── materials/ # 材料模块
│   │   ├── categories/ # 分类模块
│   │   ├── tags/      # 标签模块
│   │   └── main.ts    # 服务入口
│   └── test/          # 测试目录
├── devopsServer/      # DevOps服务
│   ├── src/
│   │   ├── deployments/ # 部署模块
│   │   ├── monitoring/ # 监控模块
│   │   ├── configurations/ # 配置模块
│   │   └── main.ts    # 服务入口
│   └── test/          # 测试目录
└── ignitionServer/    # 核心服务
    ├── src/
    │   ├── gateway/   # API网关
    │   ├── discovery/ # 服务发现
    │   └── main.ts    # 服务入口
    └── test/          # 测试目录
```

### 共享模块

```
libs/
├── common/            # 通用模块
│   ├── src/
│   │   ├── constants/ # 常量定义
│   │   ├── interfaces/ # 接口定义
│   │   ├── utils/     # 工具函数
│   │   └── index.ts   # 导出入口
│   └── package.json
├── database/          # 数据库模块
│   ├── src/
│   │   ├── mysql/     # MySQL连接
│   │   ├── mongodb/   # MongoDB连接
│   │   ├── redis/     # Redis连接
│   │   └── index.ts   # 导出入口
│   └── package.json
└── logger/            # 日志模块
    ├── src/
    │   ├── formatters/ # 日志格式化
    │   ├── transports/ # 日志传输
    │   └── index.ts   # 导出入口
    └── package.json
```

### 后端模块层次

```
┌───────────────────────────────────────────┐
│               应用模块 (App Module)       │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│               核心模块 (Core Modules)     │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    数据库模块       │ │  配置模块    │ │
│  │ (DatabaseModule)    │ │(ConfigModule)│ │
│  └─────────────────────┘ └──────────────┘ │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    日志模块         │ │  缓存模块    │ │
│  │ (LoggerModule)      │ │(CacheModule) │ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│               特性模块 (Feature Modules)  │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    用户模块         │ │  角色模块    │ │
│  │  (UsersModule)      │ │(RolesModule) │ │
│  └─────────────────────┘ └──────────────┘ │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    材料模块         │ │  标签模块    │ │
│  │  (MaterialsModule)  │ │(TagsModule)  │ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────┬───────────────────────────┘
                │
┌───────────────▼───────────────────────────┐
│            共享模块 (Shared Modules)      │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    工具模块         │ │  常量模块    │ │
│  │  (UtilsModule)      │ │(ConstsModule)│ │
│  └─────────────────────┘ └──────────────┘ │
│  ┌─────────────────────┐ ┌──────────────┐ │
│  │    过滤器模块       │ │  拦截器模块  │ │
│  │  (FiltersModule)    │ │(Interceptors)│ │
│  └─────────────────────┘ └──────────────┘ │
└───────────────────────────────────────────┘
```

## 数据流架构

### 前端数据流

```
┌─────────────┐    API请求     ┌─────────────┐
│  UI组件     │───────────────▶│  API服务    │
└─────────────┘                └──────┬──────┘
      ▲                               │
      │                               │
      │ 数据渲染                      │ 数据获取
      │                               │
      │                               ▼
┌─────────────┐    状态更新   ┌─────────────┐
│  渲染层     │◀──────────────│  状态管理   │
└─────────────┘                └─────────────┘
```

### 后端数据流

```
┌─────────────┐    HTTP请求   ┌─────────────┐
│  客户端     │───────────────▶│  控制器    │
└─────────────┘                └──────┬──────┘
                                      │
                                      │ 处理请求
                                      │
                                      ▼
┌─────────────┐    查询/更新  ┌─────────────┐
│  数据库     │◀──────────────│  服务层     │
└─────────────┘                └──────┬──────┘
      ▲                               │
      │                               │
      │ 数据读写                      │ 返回数据
      │                               │
      │                               ▼
┌─────────────┐    数据映射   ┌─────────────┐
│  实体       │◀──────────────│  DTO        │
└─────────────┘                └─────────────┘
```

## 服务交互

### 服务间通信

```
┌─────────────┐    HTTP/TCP   ┌─────────────┐
│  服务A      │───────────────▶│  服务B     │
└─────────────┘                └─────────────┘
      │                               ▲
      │                               │
      ▼                               │
┌─────────────┐                ┌─────────────┐
│  消息队列   │───────────────▶│  服务C     │
└─────────────┘                └─────────────┘
```

### 认证流程

```
┌─────────────┐    1.登录请求  ┌─────────────┐
│  客户端     │───────────────▶│ 认证服务    │
└─────────────┘                └──────┬──────┘
      ▲                               │
      │                               │2.验证凭据
      │                               ▼
      │                        ┌─────────────┐
      │                        │  用户服务   │
      │                        └──────┬──────┘
      │                               │
      │                               │3.获取权限
      │                               ▼
      │                        ┌─────────────┐
      │4.返回JWT               │  权限服务   │
      └────────────────────────┴─────────────┘
```

## 组件交互示例

### 用户登录流程

1. 用户在登录页面输入凭据
2. UI组件触发登录动作
3. 登录动作调用认证服务API
4. 认证服务验证凭据
5. 成功验证后生成JWT令牌
6. 前端存储JWT令牌
7. 更新认证状态
8. 重定向到主页

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ 登录组件 │     │ 认证Hook│     │ API服务 │     │ 后端API │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │                │               │
     │ 输入凭据      │                │               │
     │───────────────┘                │               │
     │                                │               │
     │ 调用login()                    │               │
     │───────────────────────────────▶│               │
     │                                │ POST /auth/login
     │                                │──────────────▶│
     │                                │               │ 验证凭据
     │                                │               │
     │                                │ 返回JWT令牌   │
     │                                │◀─────────────│
     │                                │               │
     │ 设置认证状态                   │               │
     │◀───────────────────────────────│               │
     │                                │               │
     │ 重定向到主页                   │               │
     │                                │               │
     └────────────────────────────────┘               │
```

### 获取用户列表流程

1. 用户管理页面加载
2. 页面组件调用用户Hook获取数据
3. 用户Hook调用API服务
4. API服务发送HTTP请求到后端
5. 后端控制器处理请求
6. 服务层获取数据
7. 数据返回到前端
8. 更新状态和UI渲染

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│用户页面 │    │用户Hook │    │ API服务 │    │ 后端API │
└────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘
     │              │               │              │
     │ useEffect()  │               │              │
     │──────────────┘               │              │
     │                              │              │
     │ 调用getUsers()               │              │
     │─────────────────────────────▶│              │
     │                              │ GET /users   │
     │                              │─────────────▶│
     │                              │              │ 获取用户数据
     │                              │              │
     │                              │ 返回用户列表 │
     │                              │◀────────────│
     │                              │              │
     │ 设置用户状态                 │              │
     │◀─────────────────────────────│              │
     │                              │              │
     │ 渲染用户列表                 │              │
     │                              │              │
```

## 模块依赖关系

### 前端依赖关系

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 页面组件    │────▶│ 业务组件    │────▶│ 基础组件    │
└─────────────┘     └─────────────┘     └─────────────┘
      │                    │                   │
      ▼                    ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 路由系统    │     │ 状态管理    │     │ 工具函数    │
└─────────────┘     └─────────────┘     └─────────────┘
      │                    │                   │
      └────────────────────┼───────────────────┘
                           ▼
                    ┌─────────────┐
                    │ API服务     │
                    └─────────────┘
```

### 后端依赖关系

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 控制器      │────▶│ 服务        │────▶│ 仓储        │
└─────────────┘     └─────────────┘     └─────────────┘
      │                    │                   │
      ▼                    ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ DTO         │     │ 实体        │     │ 数据库模块  │
└─────────────┘     └─────────────┘     └─────────────┘
      │                    │                   │
      └────────────────────┼───────────────────┘
                           ▼
                    ┌─────────────┐
                    │ 核心模块    │
                    └─────────────┘
```

## 跨域通信策略

系统采用多种方式确保跨域通信安全可靠：

1. **CORS配置**：API网关统一配置跨域资源共享策略
2. **JWT认证**：所有API请求需要JWT令牌验证
3. **API网关**：所有请求通过网关路由，提供统一访问点

```
┌─────────────┐                    ┌─────────────┐
│ 前端应用    │                    │ API网关     │
│ (端口8000)  │                    │ (端口3000)  │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  HTTP请求 + CORS + JWT           │
       └─────────────────────────────────▶│
                                          │
                                  ┌───────┴───────┐
                                  │ 微服务集群    │
                                  └───────────────┘
```

## 缓存策略

系统使用多级缓存策略提高性能：

1. **浏览器缓存**：静态资源缓存
2. **应用缓存**：前端状态管理和本地存储
3. **服务器缓存**：Redis缓存热门数据
4. **数据库缓存**：查询缓存和连接池

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 浏览器缓存  │     │ 应用缓存    │     │ Redis缓存   │
└─────────────┘     └─────────────┘     └─────────────┘
      │                    │                   │
      │                    │                   │
      ▼                    ▼                   ▼
┌─────────────────────────────────────────────────────┐
│                    数据库缓存                       │
└─────────────────────────────────────────────────────┘
``` 