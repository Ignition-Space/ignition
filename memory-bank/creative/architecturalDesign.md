# Ignition 创意阶段架构设计

## 系统概述

Ignition（点火引擎）是一个采用微服务架构的综合平台，旨在提供用户权限管理、材料管理和DevOps等多个功能模块。本文档详细描述Ignition系统的架构设计决策、核心组件和交互模式。

## 架构愿景

构建一个高度模块化、可扩展、可维护的分布式系统，通过微服务实现业务关注点分离，同时提供统一的用户体验。

## 架构设计原则

1. **关注点分离**：将不同业务领域划分为独立的微服务
2. **单一职责**：每个组件和服务专注于单一功能领域
3. **松耦合高内聚**：服务间通过定义良好的API交互，内部实现细节隐藏
4. **可扩展性**：支持水平扩展以应对不断增长的负载
5. **韧性设计**：采用故障隔离和熔断模式，提高系统稳定性
6. **开发效率**：Monorepo管理策略，简化依赖管理和代码共享
7. **渐进式采用**：支持新功能和服务的增量开发与部署

## 系统架构概览

Ignition系统采用分层架构，主要包括以下层次：

```
┌─────────────────────────────────┐
│         客户端应用层            │
└───────────────┬─────────────────┘
                │
                ▼
┌─────────────────────────────────┐
│            API网关层            │
└───────────────┬─────────────────┘
                │
                ▼
┌─────────────────────────────────┐
│           微服务应用层          │
└───────────────┬─────────────────┘
                │
                ▼
┌─────────────────────────────────┐
│            数据存储层           │
└─────────────────────────────────┘
```

## 核心组件设计

### 1. 客户端应用

#### 1.1 用户中心客户端

提供用户管理、角色权限管理等功能的Web应用。

**技术选型**：
- React 18+：基础UI框架
- Ant Design：企业级UI组件库
- Context API + Hooks：状态管理方案
- Axios：HTTP客户端
- React Router：路由管理

**主要模块**：
- 认证模块：用户登录、注册、令牌管理
- 用户管理模块：用户查询、创建、编辑、删除
- 角色管理模块：角色定义、权限分配
- 个人中心模块：用户资料、偏好设置

#### 1.2 材料中心客户端

提供材料管理、分类、标签等功能的Web应用。

**技术选型**：
- 与用户中心客户端共享技术栈
- 可能额外集成文件预览、图像处理组件

**主要模块**：
- 材料浏览模块：材料列表、筛选、搜索
- 材料详情模块：材料内容、元数据展示
- 材料管理模块：创建、编辑、删除材料
- 分类标签模块：材料分类、标签管理

### 2. API网关

集中式入口点，负责请求路由、负载均衡、认证授权等功能。

**技术选型**：
- NestJS：构建网关服务
- Passport.js：认证中间件
- JWT：令牌管理
- Redis：缓存会话和频率限制

**核心功能**：
- 请求路由：将请求转发到适当的微服务
- 认证授权：验证用户身份和访问权限
- 请求聚合：合并多个微服务响应
- 限流保护：防止DoS攻击
- 请求日志：记录API调用历史

### 3. 微服务应用层

#### 3.1 用户服务

管理用户账户、认证和授权的核心服务。

**技术选型**：
- NestJS：服务框架
- TypeORM：对象关系映射
- MySQL：关系型数据存储
- Redis：缓存

**领域模型**：
- User：用户实体
- Role：角色实体
- Permission：权限实体

**主要API**：
- `/auth`：认证相关端点
- `/users`：用户管理端点
- `/roles`：角色管理端点
- `/permissions`：权限管理端点

#### 3.2 材料服务

管理各类材料内容及其元数据。

**技术选型**：
- NestJS：服务框架
- Mongoose：MongoDB ODM
- MongoDB：文档型数据存储
- MinIO/S3：对象存储（文件）

**领域模型**：
- Material：材料实体
- Category：分类实体
- Tag：标签实体

**主要API**：
- `/materials`：材料管理端点
- `/categories`：分类管理端点
- `/tags`：标签管理端点
- `/files`：文件上传下载端点

#### 3.3 DevOps服务

提供部署配置、监控和日志功能。

**技术选型**：
- NestJS：服务框架
- Docker API：容器管理
- Prometheus客户端：指标收集
- ELK Stack集成：日志管理

**主要API**：
- `/deployments`：部署管理端点
- `/configurations`：配置管理端点
- `/monitoring`：监控数据端点
- `/logs`：日志查询端点

### 4. 数据存储层

#### 4.1 关系型数据库 (MySQL)

存储结构化数据，如用户、角色、权限等。

**主要表**：
- users：用户基本信息
- roles：角色定义
- permissions：权限定义
- user_roles：用户-角色映射
- role_permissions：角色-权限映射

#### 4.2 文档型数据库 (MongoDB)

存储非结构化或半结构化数据，如材料内容、标签等。

**主要集合**：
- materials：材料内容和元数据
- categories：材料分类信息
- tags：标签信息

#### 4.3 缓存 (Redis)

提供高性能缓存，用于会话、频繁访问数据等。

**主要用途**：
- 用户会话存储
- API请求频率限制
- 热点数据缓存

## 跨切面关注点

### 1. 认证与授权

采用JWT + RBAC模型实现认证授权：

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│用户登录 │────▶│获取JWT │────▶│附加请求 │
└─────────┘     └─────────┘     └─────────┘
                                      │
                                      ▼
┌─────────┐     ┌─────────┐     ┌─────────┐
│返回资源 │◀────│检查权限 │◀────│验证JWT │
└─────────┘     └─────────┘     └─────────┘
```

### 2. 日志与监控

实现集中式日志收集和监控：

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│应用日志 │────▶│日志聚合 │────▶│日志存储 │
└─────────┘     └─────────┘     └─────────┘
                                      │
                                      ▼
┌─────────┐     ┌─────────┐     ┌─────────┐
│报警系统 │◀────│日志分析 │◀────│日志查询 │
└─────────┘     └─────────┘     └─────────┘
```

### 3. 容错与弹性

通过断路器、重试机制等实现系统弹性：

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│客户端请求│───▶│断路器  │───▶│微服务  │
└─────────┘    └─────────┘    └─────────┘
      │             │服务降级      │
      │             ▼             │超时/故障
      │        ┌─────────┐        │
      └────────│回退响应│◀───────┘
               └─────────┘
```

## 演进策略

1. **增量开发**：先构建核心功能，再逐步添加扩展功能
2. **技术债务管理**：定期重构和优化代码
3. **前向兼容**：API版本控制，确保向后兼容性
4. **特性开关**：通过配置启用/禁用功能

## 下一步工作

1. 完善各微服务的详细设计
2. 设计数据库模式和关系
3. 定义服务间通信协议
4. 建立CI/CD流水线
5. 制定测试策略和质量保证措施 